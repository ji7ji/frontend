<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WeChat Mock - 独立本地版</title>
    <!-- 引入 Tailwind CSS 进行快速样式构建 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FontAwesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // 配置 Tailwind 主题色（微信风格）
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'wechat-bg': '#ededed',
                        'wechat-green': '#95ec69',
                        'wechat-dark-green': '#07c160',
                        'wechat-header': '#f5f5f5',
                        'wechat-text-dark': '#1a1a1a',
                    }
                }
            }
        }
    </script>
    <style>
        /* 隐藏滚动条但保留滚动功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* 聊天气泡的小尾巴 */
        .bubble-right::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 12px;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 8px solid #95ec69;
        }
        .bubble-left::after {
            content: '';
            position: absolute;
            left: -8px;
            top: 12px;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 8px solid white;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Segoe UI, Arial, Roboto, 'PingFang SC', 'miui', 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-200 h-screen w-screen flex justify-center items-center overflow-hidden">

    <!-- 移动端容器（模拟手机屏幕） -->
    <div class="bg-wechat-bg w-full h-full sm:w-[400px] sm:h-[800px] sm:rounded-3xl sm:shadow-2xl sm:border-4 border-gray-800 flex flex-col relative overflow-hidden">
        
        <!-- ================= 登录/注册界面 ================= -->
        <div id="login-screen" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center p-6">
            <div class="text-4xl text-wechat-dark-green mb-8">
                <i class="fa-solid fa-comment-dots"></i>
            </div>
            <h1 class="text-2xl font-bold mb-8 text-gray-800">欢迎登录</h1>
            
            <!-- 头像上传 -->
            <div class="mb-6 relative group cursor-pointer" onclick="document.getElementById('avatar-input').click()">
                <div id="avatar-preview" class="w-24 h-24 rounded-xl bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden transition-all group-hover:border-wechat-dark-green">
                    <i class="fa-solid fa-camera text-gray-400 text-2xl" id="avatar-icon"></i>
                </div>
                <input type="file" id="avatar-input" accept="image/*" class="hidden" onchange="previewAvatar(event)">
                <p class="text-xs text-center text-gray-500 mt-2">点击上传头像</p>
            </div>

            <!-- 用户名输入 -->
            <div class="w-full max-w-xs mb-8">
                <input type="text" id="username-input" placeholder="请输入你的用户名" class="w-full border-b-2 border-gray-300 focus:border-wechat-dark-green outline-none py-2 text-lg text-center transition-colors">
            </div>

            <!-- 登录按钮 -->
            <button onclick="loginUser()" class="w-full max-w-xs bg-wechat-dark-green text-white py-3 rounded-lg font-bold text-lg hover:bg-green-600 transition-colors active:scale-95">
                进入微信
            </button>
        </div>

        <!-- ================= 主聊天界面 ================= -->
        <div id="app-screen" class="hidden flex-col h-full w-full">
            
            <!-- 顶部导航栏 -->
            <div class="bg-wechat-header h-14 flex items-center justify-between px-4 border-b border-gray-300 shrink-0">
                <div class="flex items-center text-wechat-text-dark cursor-pointer" onclick="logout()">
                    <i class="fa-solid fa-angle-left text-xl mr-2"></i>
                    <span class="text-lg">退出</span>
                </div>
                <h1 class="font-bold text-lg text-wechat-text-dark">群聊大厅 (<span id="user-count">1</span>)</h1>
                <div class="text-wechat-text-dark text-xl">
                    <i class="fa-solid fa-ellipsis"></i>
                </div>
            </div>

            <!-- 消息列表区 -->
            <div id="message-list" class="flex-1 overflow-y-auto no-scrollbar p-4 flex flex-col space-y-6">
                <!-- 消息气泡将在这里动态生成 -->
            </div>

            <!-- 底部输入栏 -->
            <div class="bg-wechat-header border-t border-gray-300 p-2 shrink-0 flex items-end space-x-2">
                <!-- 语音按钮（仅占位装饰） -->
                <button class="w-10 h-10 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors shrink-0">
                    <i class="fa-solid fa-microphone text-xl"></i>
                </button>
                
                <!-- 文本输入框 -->
                <textarea id="text-input" rows="1" class="flex-1 rounded-md py-2 px-3 outline-none text-base resize-none max-h-32 overflow-y-auto" placeholder="发消息..." oninput="autoResize(this)"></textarea>
                
                <!-- 发送按钮 (初始隐藏) -->
                <button id="send-btn" onclick="sendTextMessage()" class="hidden bg-wechat-dark-green text-white px-4 py-2 rounded text-sm font-bold shrink-0">发送</button>
                
                <!-- 多媒体上传按钮 -->
                <button id="add-btn" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors shrink-0" onclick="document.getElementById('media-input').click()">
                    <i class="fa-solid fa-circle-plus text-2xl"></i>
                </button>
                <input type="file" id="media-input" accept="image/*,video/*" class="hidden" onchange="sendMediaMessage(event)">
            </div>
        </div>
    </div>

    <!-- ================= 核心底层逻辑代码 ================= -->
    <script>
        /**
         * 数据库接口层 (Database Interface)
         * 使用 HTML5 IndexedDB 来实现本地持久化存储，支持存储大文件（Blob类型的图片和视频）
         */
        const DB_NAME = 'WeChatMockDB';
        const DB_VERSION = 1;
        let dbInstance = null;

        const AppDB = {
            // 初始化数据库连接
            init: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        // 表1：用户表（键值：用户名）
                        if (!db.objectStoreNames.contains('users')) {
                            db.createObjectStore('users', { keyPath: 'username' });
                        }
                        // 表2：消息表（键值：自增ID）
                        if (!db.objectStoreNames.contains('messages')) {
                            const msgStore = db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
                            // 创建针对用户名的索引，方便查询特定用户的消息
                            msgStore.createIndex('username', 'username', { unique: false });
                            msgStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };

                    request.onsuccess = (event) => {
                        dbInstance = event.target.result;
                        resolve(dbInstance);
                    };

                    request.onerror = (event) => {
                        console.error('数据库初始化失败:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },

            // 接口：保存/更新用户信息 (包含用户名和头像Blob)
            saveUser: function(userObj) {
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    const request = store.put(userObj);
                    request.onsuccess = () => resolve(true);
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            // 接口：获取特定用户信息
            getUser: function(username) {
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const request = store.get(username);
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            // 接口：获取所有用户（用于头像映射和统计）
            getAllUsers: function() {
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const request = store.getAll();
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            // 接口：保存消息记录 (支持文字文本，或者图片/视频的Blob数据)
            saveMessage: function(msgObj) {
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(['messages'], 'readwrite');
                    const store = transaction.objectStore('messages');
                    const request = store.add(msgObj);
                    request.onsuccess = (e) => {
                        msgObj.id = e.target.result; // 获取自增插入的ID
                        resolve(msgObj);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            },

            // 接口：获取所有历史消息并按时间排序
            getAllMessages: function() {
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(['messages'], 'readonly');
                    const store = transaction.objectStore('messages');
                    const request = store.getAll();
                    request.onsuccess = (e) => {
                        let messages = e.target.result;
                        messages.sort((a, b) => a.timestamp - b.timestamp);
                        resolve(messages);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            }
        };

        // ================= 业务逻辑与 UI 交互 =================

        let currentUser = null;          // 当前登录的用户对象
        let currentAvatarBlob = null;    // 登录时暂存的头像文件数据
        let objectUrlCache = {};         // 缓存 blob URLs 避免内存泄漏
        let allUsersMap = {};            // 缓存所有用户头像以便渲染历史消息

        // 页面初始化
        window.onload = async () => {
            try {
                await AppDB.init();
                console.log("数据库加载成功！");
                
                // 检查是否已经登录（刷新页面保持登录状态）
                const savedSession = sessionStorage.getItem('currentWeChatUser');
                if (savedSession) {
                    currentUser = await AppDB.getUser(savedSession);
                    if (currentUser) {
                        enterApp();
                    }
                }
            } catch (error) {
                alert("数据库初始化失败，请使用支持 IndexedDB 的现代浏览器。");
            }

            // 监听输入框变化，切换发送/添加按钮
            const textInput = document.getElementById('text-input');
            const sendBtn = document.getElementById('send-btn');
            const addBtn = document.getElementById('add-btn');

            textInput.addEventListener('input', () => {
                if (textInput.value.trim().length > 0) {
                    sendBtn.classList.remove('hidden');
                    addBtn.classList.add('hidden');
                } else {
                    sendBtn.classList.add('hidden');
                    addBtn.classList.remove('hidden');
                }
            });
            
            // 监听回车键发送
            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendTextMessage();
                }
            });
        };

        // 自动调整输入框高度
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // 头像预览处理
        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                currentAvatarBlob = file;
                const url = URL.createObjectURL(file);
                const previewDiv = document.getElementById('avatar-preview');
                previewDiv.innerHTML = `<img src="${url}" class="w-full h-full object-cover" />`;
            }
        }

        // 登录/注册逻辑
        async function loginUser() {
            const usernameInput = document.getElementById('username-input').value.trim();
            if (!usernameInput) {
                alert("请输入用户名！");
                return;
            }

            let user = await AppDB.getUser(usernameInput);
            
            if (!user) {
                // 新用户注册
                if (!currentAvatarBlob) {
                    alert("新用户请先上传一个头像！");
                    return;
                }
                user = {
                    username: usernameInput,
                    avatar: currentAvatarBlob
                };
                await AppDB.saveUser(user);
            } else {
                // 老用户登录，如果选了新头像则更新
                if (currentAvatarBlob) {
                    user.avatar = currentAvatarBlob;
                    await AppDB.saveUser(user);
                }
            }

            currentUser = user;
            sessionStorage.setItem('currentWeChatUser', user.username);
            enterApp();
        }

        // 退出登录
        function logout() {
            sessionStorage.removeItem('currentWeChatUser');
            currentUser = null;
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            // 清理输入框
            document.getElementById('username-input').value = '';
            document.getElementById('avatar-preview').innerHTML = `<i class="fa-solid fa-camera text-gray-400 text-2xl" id="avatar-icon"></i>`;
            currentAvatarBlob = null;
        }

        // 进入主界面
        async function enterApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('flex');
            
            // 刷新用户映射表
            const users = await AppDB.getAllUsers();
            document.getElementById('user-count').innerText = users.length;
            
            allUsersMap = {};
            for (let u of users) {
                if (u.avatar) {
                    allUsersMap[u.username] = URL.createObjectURL(u.avatar);
                }
            }

            // 加载历史消息
            loadMessages();
        }

        // ================= 消息发送与渲染 =================

        // 发送文本消息
        async function sendTextMessage() {
            const input = document.getElementById('text-input');
            const text = input.value.trim();
            if (!text) return;

            const msgObj = {
                username: currentUser.username,
                type: 'text',
                content: text,
                timestamp: Date.now()
            };

            await AppDB.saveMessage(msgObj);
            
            // 清空输入框并重置高度
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('send-btn').classList.add('hidden');
            document.getElementById('add-btn').classList.remove('hidden');
            
            renderSingleMessage(msgObj);
            scrollToBottom();
        }

        // 发送多媒体消息 (图片/视频)
        async function sendMediaMessage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const isVideo = file.type.startsWith('video/');
            const type = isVideo ? 'video' : 'image';

            const msgObj = {
                username: currentUser.username,
                type: type,
                content: file, // 直接将文件 Blob 存入数据库
                timestamp: Date.now()
            };

            await AppDB.saveMessage(msgObj);
            renderSingleMessage(msgObj);
            scrollToBottom();
            
            // 重置 input file 以便下次选择同一文件也能触发 change
            event.target.value = ''; 
        }

        // 加载并渲染所有历史消息
        async function loadMessages() {
            const listContainer = document.getElementById('message-list');
            listContainer.innerHTML = ''; // 清空当前列表
            
            const messages = await AppDB.getAllMessages();
            for (let msg of messages) {
                renderSingleMessage(msg);
            }
            setTimeout(scrollToBottom, 100);
        }

        // 渲染单条消息到屏幕上
        function renderSingleMessage(msg) {
            const listContainer = document.getElementById('message-list');
            const isMe = msg.username === currentUser.username;
            
            // 获取头像URL
            let avatarUrl = allUsersMap[msg.username] || 'https://via.placeholder.com/150';

            // 处理消息内容展示
            let contentHTML = '';
            if (msg.type === 'text') {
                contentHTML = `<p class="whitespace-pre-wrap word-break">${escapeHTML(msg.content)}</p>`;
            } else if (msg.type === 'image') {
                const imgUrl = URL.createObjectURL(msg.content);
                contentHTML = `<img src="${imgUrl}" class="max-w-[200px] max-h-[200px] rounded-lg cursor-pointer" onclick="window.open('${imgUrl}')"/>`;
            } else if (msg.type === 'video') {
                const vidUrl = URL.createObjectURL(msg.content);
                contentHTML = `<video src="${vidUrl}" controls class="max-w-[200px] max-h-[200px] rounded-lg bg-black"></video>`;
            }

            // 构建 DOM 结构 (区分左右排列)
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'}`;

            const timeString = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            if (isMe) {
                // 自己发出的消息在右侧
                msgDiv.innerHTML = `
                    <div class="flex items-start max-w-[80%]">
                        <div class="flex flex-col items-end mr-3">
                            <span class="text-xs text-gray-400 mb-1">${timeString}</span>
                            <div class="relative bg-wechat-green text-black px-3 py-2 rounded-lg text-base shadow-sm bubble-right">
                                ${contentHTML}
                            </div>
                        </div>
                        <img src="${avatarUrl}" class="w-10 h-10 rounded-md shrink-0 object-cover bg-white">
                    </div>
                `;
            } else {
                // 别人发出的消息在左侧
                msgDiv.innerHTML = `
                    <div class="flex items-start max-w-[80%]">
                        <img src="${avatarUrl}" class="w-10 h-10 rounded-md shrink-0 object-cover bg-white">
                        <div class="flex flex-col items-start ml-3">
                            <span class="text-xs text-gray-500 mb-1">${msg.username} · ${timeString}</span>
                            <div class="relative bg-white text-black px-3 py-2 rounded-lg text-base shadow-sm bubble-left">
                                ${contentHTML}
                            </div>
                        </div>
                    </div>
                `;
            }

            listContainer.appendChild(msgDiv);
        }

        // 辅助工具：防 XSS 注入
        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag] || tag)
            );
        }

        // 辅助工具：滚动到底部
        function scrollToBottom() {
            const listContainer = document.getElementById('message-list');
            listContainer.scrollTop = listContainer.scrollHeight;
        }

    </script>
<script src="client_api.js"></script>
</body>
</html>